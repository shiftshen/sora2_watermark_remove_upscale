<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Upscaler æ§åˆ¶å°</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;background:#f5f5f5;margin:0}
    .container{max-width:1000px;margin:20px auto;padding:20px}
    .card{background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:20px;margin-bottom:20px}
    .btn{padding:10px 16px;border:none;border-radius:6px;color:#fff;margin-right:10px;cursor:pointer}
    .btn-success{background:#27ae60}.btn-danger{background:#e74c3c}.btn-primary{background:#3498db}.btn-warning{background:#f39c12}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    h1{margin:0 0 10px}
    .status{padding:8px 12px;border-radius:20px;display:inline-block}
    .running{background:#d5f4e6;color:#27ae60}.stopped{background:#fadbd8;color:#e74c3c}
    .logs{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:10px;height:160px;overflow:auto}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>ğŸ¬ Upscaler æ§åˆ¶å°</h1>
      <div id="status" class="status">åŠ è½½ä¸­...</div>
      <div style="margin-top:12px">
        <button class="btn btn-success" onclick="start(true)">å¼€å¯å¹¶åˆ é™¤æº</button>
        <button class="btn btn-primary" onclick="start(false)">å¼€å¯å¹¶ä¿ç•™æº</button>
        <button class="btn btn-danger" onclick="stop()">åœæ­¢</button>
        <button class="btn btn-warning" onclick="processExisting()">å¤„ç†ç°æœ‰ Output</button>
      </div>
    </div>

    <div class="card">
      <h2>ä»»åŠ¡æ‘˜è¦</h2>
      <div id="summaryCounts" style="margin-bottom:10px"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
        <div>
          <h3>å¾…å¤„ç†</h3>
          <ul id="listPending"></ul>
        </div>
        <div>
          <h3>å¤„ç†ä¸­</h3>
          <ul id="listProcessing"></ul>
        </div>
        <div>
          <h3>å·²å®Œæˆ</h3>
          <ul id="listCompleted"></ul>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>æ—¥å¿—</h2>
      <div id="logs" class="logs"></div>
    </div>
  </div>

  <script>
    async function refresh(){
      const s=await fetch('/upscaler/api/ups/status').then(r=>r.json()).catch(()=>({success:false}))
      const el=document.getElementById('status')
      if(s.success){
        el.className='status '+(s.data.running?'running':'stopped')
        el.textContent=(s.data.running?'è¿è¡Œä¸­':'å·²åœæ­¢')+' | æ—¥å¿—: '+s.data.logFile
      }else{
        el.className='status stopped';el.textContent='æ¥å£ä¸å¯ç”¨'
      }
      const sum=await fetch('/upscaler/api/ups/summary').then(r=>r.json()).catch(()=>({success:false}))
      if(sum.success){
        document.getElementById('summaryCounts').textContent=`Output: ${sum.data.counts.output} | å¾…å¤„ç†: ${sum.data.counts.pending} | å¤„ç†ä¸­: ${sum.data.counts.processing} | å·²å®Œæˆ: ${sum.data.counts.completed}`
        const lp=document.getElementById('listPending');lp.innerHTML=sum.data.lists.pending.map(n=>`<li>${n}</li>`).join('')
        const lpr=document.getElementById('listProcessing');lpr.innerHTML=sum.data.lists.processing.map(n=>`<li>${n}</li>`).join('')
        const lc=document.getElementById('listCompleted');lc.innerHTML=sum.data.lists.completed.map(n=>`<li>${n}</li>`).join('')
      }
      const lg=await fetch('/upscaler/api/ups/logs').then(r=>r.json()).catch(()=>({success:false}))
      document.getElementById('logs').textContent=lg.success?lg.data.tail:'(æ— æ—¥å¿—)'
    }
    async function start(del){await fetch('/upscaler/api/ups/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({deleteSourceOnSuccess:del})});setTimeout(refresh,1200)}
    async function stop(){await fetch('/upscaler/api/ups/stop',{method:'POST'});setTimeout(refresh,800)}
    async function processExisting(){const r=await fetch('/upscaler/api/ups/process-existing',{method:'POST'}).then(r=>r.json());alert('å·²æäº¤ '+(r.data?.submitted||0)+' ä¸ªè§†é¢‘');}
    refresh();setInterval(refresh,5000)
  </script>
</body>
</html>
