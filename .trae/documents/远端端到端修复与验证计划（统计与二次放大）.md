## 当前问题归因
- 统计口径不准：把隐藏/系统文件算入，且只看大写 `Output`，与实际小写 `output`不一致。
- ComfyUI未执行：工作流读取主机路径而不是容器卷 `/app/ComfyUI/input`；容器日志显示 `Invalid video file`，导致队列始终 Idle。
- 文件清理时机：未确认成功保存到 `outputupscaler` 前不应删除 `output` 源文件；失败需保留到 `Failed` 并保留子目录结构。

## 修复目标
- 统计只计真实视频，过滤 `.DS_Store`/`._*`/隐藏文件；不计目录；Output 统一为小写 `output` 并兼容大写 `Output`。
- 放大服务复制视频到容器卷 `/data/comfyui/input`，工作流 `VHS_LoadVideo` 用 `<文件名> + subfolder='input'`，提交成功并将结果保存到 `outputupscaler/<同级子目录>`；仅成功后删除源文件，失败保留到 `Failed/<同级子目录>`。

## 具体修复步骤
### A. 面板统计修复（只读接口逻辑）
- 在统计函数中：
  - 只使用 `isVideoFile` 过滤文件；排除 `basename` 以 `.` 或 `._` 开头的条目；不把目录计为文件。
  - Output 同时合并大写 `Output` 与小写 `output` 的视频集合，最终呈现为一个 `OUTPUT` 计数。
  - `unprocessedCount` 以基名对比，统一 `_clean/_out/_processed/_result` 后缀。
- 合并 `/api/batch/stats` 重复路由，统一返回 `pending/processing/isProcessing/uptime/queueLen`。

### B. 放大服务修复（autoupscaler）
- 目录与卷对齐：
  - 固定监听小写 `output`；保留源文件的相对子目录结构到 `outputupscaler` 与 `Failed`。
  - 环境：`COMFY_BASE_URL=http://127.0.0.1:28188`、`COMFY_INPUT_DIR=/data/comfyui/input`、`OUTPUT_DIR=/home/data/water_mark_remove/output`。
- 工作流注入与提交流程：
  - 复制源视频到 `/data/comfyui/input`，最小清理文件名（去 `._` 前缀、替换不可见字符）。
  - 将 `VHS_LoadVideo.inputs.video=<复制后的文件名>`、`inputs.subfolder='input'`、`inputs.format='Upload'`，并清空 `inputs.path`。
  - 调用 `/api/prompt`（附 `client_id`）→ 轮询 `/api/history/{prompt_id}` → 通用解析 `outputs` 任意键并下载。
  - 仅成功后删除 `output` 源文件；失败移动到 `Failed/<同级子目录>` 并记录错误。
  - 过滤 0 字节与 `._*` 伪文件，避免误触发。

### C. 运行环境对齐
- 去水印主服务启动采用 `OUTPUT_DIR=/home/data/water_mark_remove/output`；将历史 `Output/` 合并迁移到小写 `output/`。
- 保持两条流水线自动化：
  - 去水印：`input -> output`。
  - 二次放大：监听 `output` → ComfyUI → `outputupscaler`，成功清理源文件。

## 端到端测试流程
1. 放一个非零 mp4 到 `output/test/`。
2. 预期日志：
  - 放大服务：`processing` → `submitted prompt: <id>` → `saved: /home/data/water_mark_remove/outputupscaler/test/...`。
  - 容器：不再出现 `Invalid video file`；队列从 Idle 进入执行。
3. 目录结果：
  - `output/test/` 源文件删除（仅成功时）；`outputupscaler/test/` 出现最终视频；失败文件在 `Failed/test/`。
4. 面板一致性：
  - `GET /api/stats` 与 `GET /api/debug/input-files`/`output-files` 数值一致；不计目录与隐藏文件。

## 风险与回滚
- 改动范围仅限统计接口与 autoupscaler；不改变去水印核心处理逻辑。
- 若出现异常：回滚统计补丁，停用 autoupscaler，保持 `25348` 主面板不受影响。

## 需要你的确认
- 统一 Output 为小写 `output`（我会迁移历史产物并保持目录干净）。
- 失败文件是否保留在 `output` 或移动到 `Failed`（当前方案：失败移动到 `Failed`，成功后删除源）。

收到确认后我将立即在远端按以上步骤执行修复并完成完整测试，并把验证结果截图与接口返回值发给你。