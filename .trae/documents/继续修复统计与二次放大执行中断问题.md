## 修复目标
- 统计口径与目录大小写完全正确：Input 仅计真实视频文件，不计文件夹/隐藏/系统文件；Output 统一为小写 `output` 并兼容大写 `Output`。
- 二次放大全链路稳定：自动提交到 ComfyUI，输出到 `outputupscaler`，仅在成功后删除 `output` 源文件，失败保存到 `Failed`；保留子目录结构。

## 阶段 A：统计修复（面板）
1. 明确计数策略：
- Input 只统计视频文件（`isVideoFile`），过滤 `.DS_Store`、`._*`、隐藏文件；不把目录计为文件。
- Output 统计视频文件，并合并小写 `output` 与大写 `Output` 的文件集合（最终呈现为一个 `OUTPUT` 数）。
- `unprocessedCount` 按基名对比（`normalizeBaseName`），不受 `_clean/_out/_processed/_result` 后缀影响。
2. 保证接口一致：
- 合并 `/api/batch/stats` 的重复路由，返回 `pending/processing/isProcessing/uptime/queueLen`。
3. 添加诊断接口（可选）：
- `/api/debug/counters` 返回各目录真实文件列表与计数来源，便于确认“为什么是 N”。

## 阶段 B：ComfyUI 工作流与提交修复（autoupscaler）
1. 容器卷对齐与输入注入：
- 将 `output` 的源视频复制到容器主机卷 `/data/comfyui/input`（与容器 `/app/ComfyUI/input` 映射）。
- 工作流节点注入：`VHS_LoadVideo.inputs.video=<复制后的文件名>`、`inputs.subfolder='input'`、`inputs.format='Upload'`；清空 `inputs.path`。
- 文件名最小清理：移除 `._` 前缀，替换不可见字符，保留扩展名。
2. 提交流程稳健化：
- 提交 `/api/prompt` 时附 `client_id`；轮询 `/api/history/{prompt_id}`；通用解析 `outputs` 任意键并下载到 `outputupscaler/<相对子目录>/`。
- 提交前验证：使用 `/api/view?type=input` 验证容器能读取该文件；失败则记录错误，不删除源文件。
3. 失败容错：
- 遇到 `Prompt outputs failed validation` 时，自动切换 `format='Upload'`（如工作流为 `AnimateDiff`），仍失败则移动到 `Failed/<相对子目录>/` 并保留错误信息。
4. 删除策略保证：
- 仅在“已成功保存到 `outputupscaler`”后删除 `output` 源文件；失败不删除源目录以便复查（或按你要求保留/删除）。

## 阶段 C：运行与监控
1. 远端服务对齐：统一 `OUTPUT_DIR=/home/data/water_mark_remove/output`；历史 `Output/` 合并迁移到 `output/`。
2. 状态接口（可选）：
- `GET /autoupscaler/status` 返回二次放大队列 `pending/processing/last_error`，便于面板显示“放大服务状态”。

## 阶段 D：端到端测试
1. 准备一个非零 mp4 放入 `output/test/`。
2. 预期行为：
- 放大服务日志出现 `submitted prompt: <id>` 与 `saved: /home/data/water_mark_remove/outputupscaler/test/...`。
- 源文件从 `output/test/` 删除；失败时写入 `Failed/test/` 并保留错误。
- 面板 `api/stats` 与 `debug` 两端点数值一致，`inputCount` 与文件系统一致，无文件夹计数。

## 安全与回滚
- 所有改动仅限统计与 `autoupscaler`，不改变去水印处理逻辑；有问题可一键回退统计补丁并停用二次放大服务，不影响 `25348` 主面板。

## 需要你的确认
- 是否将 Output 统一为小写 `output`（我会迁移历史产物并保持目录干净）。
- 失败文件是否仍要从 `output/` 删除（当前方案：仅成功后删除源文件；失败移到 `Failed`）。

确认后我立即按照上述步骤在远端执行修复与完整测试。